*** Begin Patch
*** Update File: model/getOTP.php
@@
-<?php
-session_start();
-require_once 'config.php';
-require_once '../config/fw.php';
- = curl_init();
-
- = [
-  'Authorization: Bearer ' . FLW_SECRET_KEY_TEST,
-  'Content-Type: application/json'
-];
-
-// Set the appropriate headers for JSON response
-header('Content-Type: application/json');
-
-if (isset(['getOtp'])) {
-   = null;
-
-  if (['getOtp'] == 'get') {
-     = ['email'];
-
-    // Check if the user exists in the database
-     = mysqli_query(, "SELECT * FROM admins WHERE email = ''");
-
-    // Fetch user data
-     = mysqli_fetch_assoc();
-
-    if (!) {
-      // Create a new array with the desired fields
-       = [
-        'status' => "error",
-        'message' => "Email not found!",
-        'reference' => null,
-        'otp' => null,
-      ];
-
-      // Encode the filtered data as JSON and send it
-      echo json_encode();
-      exit();
-    } else {
-       = 'https://api.flutterwave.com/v3/otps';
-       = [
-        "length" => 7,
-        "customer" => [
-          "name" => ['first_name'] . ' ' . ['last_name'],
-          "email" => ,
-          "phone" => ['phone']
-        ],
-        "sender" => "Nivasity",
-        "send" => true,
-        "medium" => ["email"],
-        "expiry" => 10
-      ];
-    }
-  } else {
-     = md5(['password']);
-     = ['otp'];
-     = ['ref'];
-     = "https://api/flutterwave.com/v3/otps//validate";
-     = ["otp" => ];
-  }
-
-  // Set cURL options
-  curl_setopt_array(, [
-    CURLOPT_URL => ,
-    CURLOPT_RETURNTRANSFER => true,
-    CURLOPT_ENCODING => '',
-    CURLOPT_MAXREDIRS => 10,
-    CURLOPT_TIMEOUT => 0,
-    CURLOPT_FOLLOWLOCATION => true,
-    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
-    CURLOPT_CUSTOMREQUEST => 'POST',
-    CURLOPT_POSTFIELDS => json_encode(),
-    CURLOPT_HTTPHEADER => ,
-  ]);
-
-   = curl_exec();
-
-  // Close cURL session
-  curl_close();
-
-  // Decode the JSON response
-   = json_decode(, true);
-
-  // Extract the first entry in the 'data' array
-   = ['data'][0] ?? null;
-
-  if (['status'] == 'success') {
-    if ( == null) {
-      ["reset_email"] = ;
-    } else {
-       = ["reset_email"];
-
-      // Update the user's password in the database using mysqli_query
-      mysqli_query(, "UPDATE admins SET password = '' WHERE email = ''");
-    }
-  }
-  // Create a new array with the desired fields
-   = [
-    'status' => ['status'] ?? null,
-    'message' => ['message'] ?? null,
-    'reference' => ['reference'] ?? null,
-    'otp' => ['otp'] ?? null,
-  ];
-
-  // Encode the filtered data as JSON and send it
-  echo json_encode();
-}
-?>
+<?php
+session_start();
+require_once 'config.php';
+require_once 'mail.php';
+
+header('Content-Type: application/json');
+
+function generate_otp( = 6) {
+   = (int) str_pad('1', , '0');
+   = (int) str_pad('', , '9');
+  return (string) rand(, );
+}
+
+if (isset(['getOtp'])) {
+   = ['getOtp'];
+
+  if ( === 'get') {
+     = trim(['email'] ?? '');
+
+    // Validate email
+    if (empty() || !filter_var(, FILTER_VALIDATE_EMAIL)) {
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'Please enter a valid email.',
+        'reference' => null,
+        'otp' => null,
+      ]);
+      exit();
+    }
+
+    // Check if the user exists in the database
+     = mysqli_real_escape_string(, );
+     = mysqli_query(, "SELECT first_name, last_name FROM admins WHERE email = '{}' LIMIT 1");
+     = mysqli_fetch_assoc();
+
+    if (!) {
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'Email not found!',
+        'reference' => null,
+        'otp' => null,
+      ]);
+      exit();
+    }
+
+    // Generate a unique OTP not currently active
+     = generate_otp(6);
+     = mysqli_real_escape_string(, );
+
+    // Ensure uniqueness among active keys (low probability, but check once)
+     = mysqli_query(, "SELECT 1 FROM admin_keys WHERE _key = '{}' AND status = 'active' AND exp_date >= NOW() LIMIT 1");
+    if (mysqli_num_rows() > 0) {
+       = generate_otp(6);
+       = mysqli_real_escape_string(, );
+    }
+
+    // Insert OTP into admin_keys with 10 minutes expiry
+     = date('Y-m-d H:i:s', strtotime('+10 minutes'));
+     = mysqli_real_escape_string(, );
+    mysqli_query(, "INSERT INTO admin_keys (_key, exp_date, status) VALUES ('{}', '{}', 'active')");
+
+    // Send email
+     = trim((['first_name'] ?? '') . ' ' . (['last_name'] ?? ''));
+     = 'Your Nivasity OTP Code';
+     = '<p>Hi ' . htmlspecialchars() . ',</p>' .
+            '<p>Your one-time password (OTP) is:</p>' .
+            '<h2 style="letter-spacing:3px;margin:8px 0">' . htmlspecialchars() . '</h2>' .
+            '<p>This code expires in 10 minutes. If you did not request this, please ignore this email.</p>';
+
+     = sendMail(, , );
+
+    if ( === 'success') {
+      // Persist email in session for verification step
+      ['reset_email'] = ;
+      echo json_encode([
+        'status' => 'success',
+        'message' => 'OTP sent to your email.',
+        'reference' => '',
+        'otp' => null,
+      ]);
+    } else {
+      // Clean up the OTP we just inserted if email failed
+      mysqli_query(, "UPDATE admin_keys SET status = 'inactive' WHERE _key = '{}'");
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'Failed to send OTP email. Please try again.',
+        'reference' => null,
+        'otp' => null,
+      ]);
+    }
+
+    exit();
+  }
+
+  if ( === 'verify') {
+     = ['password'] ?? '';
+     = ['otp'] ?? '';
+     = ['reset_email'] ?? '';
+
+    if (empty()) {
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'Session expired. Please restart reset process.',
+        'reference' => null,
+        'otp' => null,
+      ]);
+      exit();
+    }
+
+    if (empty() || empty()) {
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'OTP and new password are required.',
+        'reference' => null,
+        'otp' => null,
+      ]);
+      exit();
+    }
+
+     = mysqli_real_escape_string(, trim());
+     = mysqli_real_escape_string(, );
+     = md5();
+
+    // Verify OTP against admin_keys table
+     = mysqli_query(, "SELECT _key FROM admin_keys WHERE _key = '{}' AND status = 'active' AND exp_date >= NOW() LIMIT 1");
+    if (mysqli_num_rows() === 0) {
+      echo json_encode([
+        'status' => 'error',
+        'message' => 'Invalid or expired OTP.',
+        'reference' => null,
+        'otp' => null,
+      ]);
+      exit();
+    }
+
+    // Update password
+    mysqli_query(, "UPDATE admins SET password = '{}' WHERE email = '{}' LIMIT 1");
+    // Invalidate OTP so it cannot be reused
+    mysqli_query(, "UPDATE admin_keys SET status = 'used' WHERE _key = '{}' LIMIT 1");
+
+    // Clear session email
+    unset(['reset_email']);
+
+    echo json_encode([
+      'status' => 'success',
+      'message' => 'Password reset successfully.',
+      'reference' => null,
+      'otp' => null,
+    ]);
+
+    exit();
+  }
+}
+?>
*** End Patch
