<?php
/**
 * DEMO.PHP - Quick Login Handler Example
 * 
 * This file should be placed at: https://nivasity.com/demo.php
 * 
 * Purpose: Handle quick login links for students
 * Security: Uses 64-character random codes that expire in 24 hours
 */

session_start();

// TODO: Include your database configuration
// require_once('path/to/your/config/db.php');
// For this example, assuming $conn is the database connection

// Example database connection (replace with your actual config)
/*
$conn = mysqli_connect("localhost", "username", "password", "niverpay_db");
if (!$conn) {
    die('Database connection failed');
}
*/

// Get the code from URL parameter
$code = $_GET['code'] ?? '';

if (empty($code)) {
    // No code provided - show error
    http_response_code(400);
    die('
    <!DOCTYPE html>
    <html>
    <head>
        <title>Invalid Access</title>
        <style>
            body { font-family: Arial, sans-serif; padding: 50px; text-align: center; }
            .error { color: #d32f2f; }
        </style>
    </head>
    <body>
        <h1 class="error">Invalid Access</h1>
        <p>No login code provided. Please use the link provided by your administrator.</p>
    </body>
    </html>
    ');
}

// Sanitize the code
$code = mysqli_real_escape_string($conn, $code);

// Set timezone (must match the dashboard timezone)
date_default_timezone_set('Africa/Lagos');
$now = date('Y-m-d H:i:s');

// Query to fetch the login code details
$query = "SELECT qlc.*, u.email, u.id as user_id, u.role, u.first_name, u.last_name
          FROM quick_login_codes qlc
          JOIN users u ON qlc.student_id = u.id
          WHERE qlc.code = '$code'
          AND qlc.status = 'active'
          AND qlc.expiry_datetime > '$now'
          LIMIT 1";

$result = mysqli_query($conn, $query);

if (!$result || mysqli_num_rows($result) == 0) {
    // Invalid or expired code
    http_response_code(403);
    die('
    <!DOCTYPE html>
    <html>
    <head>
        <title>Invalid Login Link</title>
        <style>
            body { font-family: Arial, sans-serif; padding: 50px; text-align: center; }
            .error { color: #d32f2f; }
            .info { color: #666; margin-top: 20px; }
        </style>
    </head>
    <body>
        <h1 class="error">Invalid or Expired Login Link</h1>
        <p>This login link is either invalid, has already been used, or has expired.</p>
        <p class="info">Quick login links are valid for 24 hours from creation.</p>
        <p class="info">Please contact your administrator to generate a new login link.</p>
    </body>
    </html>
    ');
}

$login_data = mysqli_fetch_assoc($result);

// Mark the code as used to prevent reuse
mysqli_query($conn, "UPDATE quick_login_codes SET status = 'used' WHERE code = '$code'");

// Set session variables for the user (match your application's session structure)
$_SESSION['nivas_userId'] = $login_data['user_id'];
$_SESSION['nivas_userEmail'] = $login_data['email'];
$_SESSION['nivas_userRole'] = $login_data['role'];

// Optional: Log the login for audit purposes
// You can add audit logging here if needed

// Update last login timestamp
mysqli_query($conn, "UPDATE users SET last_login = '$now' WHERE id = " . $login_data['user_id']);

// Redirect to the appropriate dashboard based on user role
// TODO: Update this URL to match your actual student dashboard
if ($login_data['role'] === 'student') {
    header('Location: /student-dashboard.php');
} else {
    // Fallback to main dashboard
    header('Location: /dashboard.php');
}
exit();
?>
