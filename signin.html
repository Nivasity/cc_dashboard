<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Sign in - Nivasity Command Center</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

    <!-- Page CSS -->
    <!-- Page -->
    <link rel="stylesheet" href="assets/vendor/css/pages/page-auth.css" />
    <!-- Helpers -->
    <script src="assets/vendor/js/helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="assets/js/config.js"></script>
  </head>

  <body>
    <!-- Content -->

    <div class="container-xxl">
      <div class="authentication-wrapper authentication-basic container-p-y">
        <div class="authentication-inner">
          <!-- Register -->
          <div class="card">
            <div class="card-body">
              <!-- Logo -->
              <div class="app-brand justify-content-center">
                <a href="/" class="app-brand-link">
                  <img class="img-fluid app-brand-logo w-50 mx-auto" src="assets/img/nivasity_cc_logo_exp.png">
                </a>
              </div>
              <!-- /Logo -->
              <h4 class="mb-2">Welcome here! ðŸ‘‹</h4>
              <p class="mb-4">Please sign-in to your account and start the adventure</p>

              <form id="signin-form" class="mb-3">
              <input type="hidden" name="login" value="login">
                <div class="mb-3">
                  <label for="email" class="form-label">Email</label>
                  <input type="text" class="form-control" name="email" placeholder="Enter your email" autofocus required />
                </div>
                <div class="mb-3 form-password-toggle">
                  <div class="d-flex justify-content-between">
                    <label class="form-label" for="password">Password</label>
                    <a href="reset_password.html">
                      <small>Forgot Password?</small>
                    </a>
                  </div>
                  <div class="input-group input-group-merge">
                    <input type="password" class="form-control" name="password" placeholder="......." aria-describedby="password" required />
                    <span class="input-group-text cursor-pointer"><i class="bx bx-hide"></i></span>
                  </div>
                </div>
                <div class="mb-3">
                  <button class="btn btn-primary d-grid w-100 signin-btn" type="submit">Sign in</button>
                </div>
              </form>
            </div>
          </div>
          <!-- /Register -->
        </div>
      </div>
    </div>

    <!-- / Content -->
    
    <!-- Toast -->
    <div class="bs-toast toast toast-placement-ex m-2 fade hide me-4 mt-4" role="alert" aria-live="assertive"
    aria-atomic="true" data-delay="2000">
    <div class="toast-header">
      <i class="bx bx-bell me-2"></i>
      <div class="me-auto fw-semibold">Alert</div>
      <!-- <small>11 mins ago</small> -->
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
      <div class="toast-body">Fruitcake chocolate bar tootsie roll gummies gummies jelly beans cake.</div>
    </div>
    <!-- / Toast -->

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="assets/vendor/libs/jquery/jquery.js"></script>
    <script src="assets/vendor/libs/popper/popper.js"></script>
    <script src="assets/vendor/js/bootstrap.js"></script>
    <script src="assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

    <script src="assets/vendor/js/menu.js"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="assets/js/ui-toasts.js"></script>

    <!-- Main JS -->
    <script src="assets/js/main.js"></script>

    <!-- Page JS -->
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      // Get the logout parameter from the URL
      const logout = urlParams.get('logout');

      // Check if the verify parameter is present
      if (logout) {
        $.ajax({
          type: 'POST',
          url: 'model/admin.php',
          data: { logout: 'logout' },
          success: function (data) {
            if (data.status == 'success') {
              showToast('bg-success', data.message);              
            }
          }
        });
      }

      // function decodeJwtResponse(jwt) {
      //   // Split the JWT into its parts (header, payload, and signature)
      //   const parts = jwt.split('.');

      //   // Decode the base64-encoded payload
      //   const decodedPayload = atob(parts[1]);

      //   // Parse the JSON-formatted payload
      //   const payloadObject = JSON.parse(decodedPayload);

      //   return payloadObject;
      // }

      // // Example usage of handleCredentialResponse
      // function handleCredentialResponse(response) {
      //   // Assuming response.credential contains a JWT
      //   const responsePayload = decodeJwtResponse(response.credential);

      //   user_email = responsePayload.email;

      //   $.ajax({
      //     type: 'POST',
      //     url: 'model/user.php',
      //     data: { login: 'g_signin', email: user_email },
      //     success: function (data) {
      //       $('#alertBanner').html(data.message);

      //       if (data.status == 'success') {
      //         $('#alertBanner').removeClass('alert-info');
      //         $('#alertBanner').removeClass('alert-danger');
      //         $('#alertBanner').removeClass('alert-warning');
      //         $('#alertBanner').addClass('alert-success');

      //         window.location.href = "store.php?loggedin";
      //       } else if (data.status == 'unverified') {
      //         $('#alertBanner').removeClass('alert-danger');
      //         $('#alertBanner').removeClass('alert-success');
      //         $('#alertBanner').removeClass('alert-info');
      //         $('#alertBanner').addClass('alert-warning');
      //       } else {
      //         $('#alertBanner').removeClass('alert-warning');
      //         $('#alertBanner').removeClass('alert-success');
      //         $('#alertBanner').removeClass('alert-info');
      //         $('#alertBanner').addClass('alert-danger');
      //       }

      //       // Automatically show and hide the alert after 5 seconds
      //       $('#alertBanner').fadeIn();

      //       setTimeout(function () {
      //         $('#alertBanner').fadeOut();
      //       }, 5000);
      //     }
      //   });
      // }

      $(document).ready(function () {
        // Use AJAX to submit the login form
        $('#signin-form').submit(function (event) {
          // Prevent the default form submission
          event.preventDefault();

          // Serialize the form data
          var formData = $(this).serialize();

          // Define login button
          var button = $('.signin-btn');
          var originalText = button.html();

          // Display the spinner and disable the button
          button.html('<div class="spinner-border text-white mx-auto" role="status" style="width: 1.5rem; height: 1.5rem;" role="status"><span class="visually-hidden">Loading...</span>');
          button.prop('disabled', true);

          // Simulate an AJAX call using setTimeout
          setTimeout(function () {
            $.ajax({
              type: 'POST',
              url: 'model/admin.php',
              data: formData,
              success: function (data) {
                if (data.status == 'success') {
                  showToast('bg-success', data.message); 

                  setTimeout(function () {
                    // Check if there's a redirect parameter in the URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectUrl = urlParams.get('redirect');
                    
                    // Redirect to the original page or default to home
                    if (redirectUrl) {
                      window.location.href = redirectUrl + (redirectUrl.includes('?') ? '&' : '?') + 'loggedin';
                    } else {
                      window.location.href = "/?loggedin";
                    }
                  }, 1000);
                } else {
                  showToast('bg-danger', data.message); 
                }

                // AJAX call successful, stop the spinner and update button text
                button.html(originalText);
                button.prop("disabled", false);
              }
            });
          }, 2000); // Simulated AJAX delay of 2 seconds
        });

      });
    </script>
  </body>
</html>
